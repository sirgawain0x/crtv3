import { onchain } from '../drizzle/onchain.js';
import { InvalidStoreAccessError, InvalidStoreMethodError, NonRetryableUserError, UndefinedTableError, } from '../internal/errors.js';
import { getTableConfig } from "drizzle-orm/pg-core";
export const validateUpdateSet = (table, set, prev, cache) => {
    const primaryKeys = cache.get(table);
    for (let i = 0; i < primaryKeys.length; i++) {
        const [js] = primaryKeys[i];
        if (js in set) {
            // Note: Noop on the primary keys if they are identical, otherwise throw an error.
            if (set[js] !== prev[js]) {
                throw new NonRetryableUserError(`Primary key column '${js}' cannot be updated`);
            }
        }
    }
};
/** Throw an error if `table` is not an `onchainTable`. */
export const checkOnchainTable = (table, method) => {
    if (table === undefined)
        throw new UndefinedTableError(`Table object passed to db.${method}() is undefined`);
    if (onchain in table)
        return;
    throw new InvalidStoreMethodError(method === "find"
        ? `db.find() can only be used with onchain tables, and '${getTableConfig(table).name}' is an offchain table or a view.`
        : `Indexing functions can only write to onchain tables, and '${getTableConfig(table).name}' is an offchain table or a view.`);
};
export const checkTableAccess = (table, method, key, chainId) => {
    if (chainId === undefined)
        return;
    if ("chainId" in key && String(key.chainId) === String(chainId))
        return;
    throw new InvalidStoreAccessError("chainId" in key
        ? `db.${method}(${getTableConfig(table).name}) cannot access rows on different chains when ordering is 'isolated'.`
        : `db.${method}(${getTableConfig(table).name}) must specify 'chainId' when ordering is 'isolated'.`);
};
//# sourceMappingURL=index.js.map