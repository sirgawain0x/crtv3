# Stream ID and Stream Key Flow Explanation

## Overview
This document explains where the `streamId` (used by `listMultistreamTargets()`) comes from and how it relates to the stream key.

## Key Terminology

1. **Stream Key** (`streamKey`): 
   - The RTMP ingest key used by broadcasting software (OBS, etc.) to stream to Livepeer
   - Format: Usually a long alphanumeric string
   - Used for: Broadcasting video to Livepeer

2. **Stream ID** (`streamId`):
   - The unique identifier for the stream in Livepeer's system
   - Format: UUID or similar unique identifier
   - Used for: API operations like fetching multistream targets, updating stream settings

## Flow Diagram

```
User clicks "Create Stream"
    ↓
handleCreateStream() in app/live/[address]/page.tsx
    ↓
createStreamViaProxy() in components/Live/Broadcast.tsx
    ↓
POST /api/livepeer/livepeer-proxy
    ↓
POST https://livepeer.studio/api/stream
    ↓
Livepeer API generates and returns:
    {
      streamKey: "abc123...",      // ← For broadcasting
      id: "stream-uuid-123",       // ← For API operations (this is streamId)
      // OR nested format:
      stream: {
        streamKey: "abc123...",
        id: "stream-uuid-123"
      }
    }
    ↓
Extract both values:
    - streamKey → Used for Broadcast component
    - streamId (id) → Used for listMultistreamTargets()
    ↓
Store in state:
    - setStreamKey(streamKeyValue)
    - setStreamId(streamIdValue)
    ↓
When user wants to manage multistream targets:
    listMultistreamTargets({ streamId: streamIdValue })
    ↓
Fetches stream-specific targets from Livepeer
```

## Code Locations

### 1. Stream Creation
**File**: `app/live/[address]/page.tsx`
**Lines**: 105-174

```typescript
async function handleCreateStream() {
  // ... stream configuration ...
  const result = await createStreamViaProxy({ ... });
  
  // Extract from Livepeer API response
  const streamKeyValue = result.streamKey || result.stream?.streamKey;
  const streamIdValue = result.id || result.stream?.id;
  
  setStreamKey(streamKeyValue);  // For broadcasting
  setStreamId(streamIdValue);     // For API operations
}
```

### 2. API Proxy
**File**: `app/api/livepeer/livepeer-proxy/route.ts`
**Lines**: 3-16

```typescript
export async function POST(req: NextRequest) {
  const body = await req.json();
  const livepeerRes = await fetch("https://livepeer.studio/api/stream", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${process.env.LIVEPEER_FULL_API_KEY}`,
    },
    body: JSON.stringify(body),
  });
  
  const data = await livepeerRes.json();
  return NextResponse.json(data, { status: livepeerRes.status });
}
```

### 3. Using Stream ID for Multistream Targets
**File**: `app/live/[address]/page.tsx`
**Lines**: 46-65

```typescript
useEffect(() => {
  async function fetchTargets() {
    if (!streamId) {
      setMultistreamTargets([]);
      return;
    }
    
    // Use the streamId from stream creation
    const result = await listMultistreamTargets({ streamId });
    if (result.targets) {
      setMultistreamTargets(result.targets);
    }
  }
  fetchTargets();
}, [streamId]); // ← Depends on streamId from stream creation
```

### 4. Fetching Targets from Livepeer
**File**: `services/video-assets.ts`
**Lines**: 325-355

```typescript
export async function listMultistreamTargets(
  { streamId }: ListMultistreamTargetsParams
): Promise<ListMultistreamTargetsResult> {
  // Use streamId to fetch the specific stream
  const stream = await fullLivepeer.stream.get(streamId);
  
  // Extract multistream targets from the stream object
  const targets = stream.stream.multistream?.targets || [];
  
  return { targets: targets as MultistreamTarget[] };
}
```

## Important Points

1. **Both are generated by Livepeer**: Neither `streamKey` nor `streamId` are generated by our code - they're both returned by Livepeer API when creating a stream.

2. **Different purposes**:
   - `streamKey`: Used by broadcasting software to connect to Livepeer
   - `streamId`: Used by our application to manage stream settings via API

3. **Timing**: 
   - Both are available immediately after stream creation
   - `streamId` is required before we can fetch/manage multistream targets
   - That's why we only fetch targets after `streamId` is set

4. **Response format variations**: 
   Livepeer API can return data in different formats:
   - Flat: `{ streamKey: "...", id: "..." }`
   - Nested: `{ stream: { streamKey: "...", id: "..." } }`
   
   Our code handles both formats:
   ```typescript
   const streamKeyValue = result.streamKey || result.stream?.streamKey;
   const streamIdValue = result.id || result.stream?.id;
   ```

## Summary

**Question**: Where does the stream ID get generated from for `listMultistreamTargets()`?

**Answer**: 
- The `streamId` is **generated by Livepeer API** when you create a stream
- It's returned in the stream creation response (along with `streamKey`)
- We extract it from the response and store it in state
- We then use that stored `streamId` to call `listMultistreamTargets({ streamId })`
- The function uses `streamId` to fetch the specific stream from Livepeer and extract its multistream targets

The flow is: **Livepeer generates it → We extract it → We use it to fetch targets**

